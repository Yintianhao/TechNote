

## 索引

索引之于数据库表相当于目录之于书籍。

### 索引的常用模型

- 哈希表

  使用哈希表就会出现不同的key映射到同一个位置的情况，那么这个时候可以采用拉链法来解决冲突，即在当前位置拉出一个链表。这样当冲突的时候只需要查找链表中的元素即可，但是这样缺点也很明显，因为链表中的元素并不是有序的。这样在某些场景比如区间查询的时候效率会很低。一般用它进行等值查询。

- 有序数组

  有序数组很好地解决了哈希索引区间查找的问题，并且也支持等值查询，当然它也有缺点，那就是插入和删除操作很麻烦。

- 搜索树

  尽管二叉搜索树在查询和插入等操作上有比较好的表现，但是在数据库里面是不会用的，因为数据量大的情况下，树的高度会很大，而索引不止会在内存中，还会存在磁盘上，高度很大会让查询访问更多的数据块，时间成本太大，而使用N叉树可以避免这类问题。

### InnoDB存储引擎的索引模型

在InnoDB中，表都是根据主键顺序以索引的形式存放的，这种存储方式的表也称为索引组织表，事实上这里的索引就是B+树，也就是说每一个索引就是一个B+树。以一个表为例：

```
create table T(
id int primary key, 
k int not null, 
name varchar(16),
index (k))engine=InnoDB;

```

主键列为ID字段，另外还有字段K，并且K上建有索引。在这个例子中，主键有主键索引，那么K上的就被称为非主键索引，非主键索引中，叶子结点也就是最底层结点，存储的是主键的值，主键索引的叶子结点存储的是整行数据。		

那基于主键索引的查询和基于非主键查询有什么区别呢，重点在于一个回表的过程，主键索引由于叶子存储的是整行数据，所以查询到的就是需要的数据，但非主键查询查到的是主键的值。所以在查询到相应的主键值之后还需要到主键索引里再查一次，这个过程也就是回表。所以查询中应该尽量使用主键查询。

### 索引维护

树形结构插入的时候难免要涉及到即数据页分裂的问题，出现页分裂需要申请新的数据页同时需要将原先的数据进行移动，所以有一定性能损失，除此之外，原本的数据页的数据被分到两个数据页里，所以数据页的利用率下降了不少。		

- 自增主键的问题

许多表里都有自增主键，也有的表采用自己的业务字段做主键。那么什么场景下要使用自增的，什么情况下使用业务字段呢，由于B+树是排序树，也就是符合左孩子<父节点<右节点这样的关系，采用自增节点的时候，每次插入的记录的主键总是递增的，所以不会出现挪动其他数据的位置的情况，也不会触发叶子结点的分裂，但是使用自己的业务字段的时候，可能会有不能保证有序插入的情况，这样的话就会出现上面所说的问题。另外在存储空间占用上来考虑，自增主键的长度一般没有业务节点大，而非主键索引的叶子节点存放的是主键，索引使用自增主键一般更节省空间。

- 考虑业务字段做主键的情况

  1，这个表只有这一个索引。	

  2，这个索引必须是唯一的索引。