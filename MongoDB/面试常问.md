## Q&A

- 如何执行事务/加锁

mongod没有使用传统的锁或者复杂的带回滚的事务，因为设计的宗旨是轻量，快速以及可预计的高性能，可以类似于MySQLISAM的自动提交模式，通过精简对事务的支持，性能得到提升，特别是在一个可能会穿过多个服务器的系统里。

- 更新操作会立即fsync到磁盘么

不会，磁盘写操作是延迟执行的

，写操作可能在两三秒（默认是60s）到达磁盘，通过syncPeriodSecs启动参数，可以进行配置。

- 索引类型有哪些

单字段索引：默认使用_id来创建索引，在分片集群中使用这个索引，如果不使用它作为分片键，那么程序必须保证__id的唯一性防止出错，解决方法是可以采用objectid

复合索引：多个key组合在一起创建索引，这样可以加速多个键的查询

```
1，复合索引限制32个字段
2，无法创建具有hash索引类型的复合索引
3，复合索引创建的字段顺序是很重要的，因为索引以升序降序排序顺序存储字段的引用，对于单字段键的顺序就无关紧要了。
4，除了支持所有索引字段上匹配的查询之外，复合索引还可以支持索引字段的前缀匹配的查询。
```

多键索引：使用多键索引为数组的每个元素都创建索引，多键索引可以在字符串，数字等key上创建。如果索引子墩包含数组值，那么mongodb会自动确定是否创建多键索引。

全文索引：支持在collection里搜索字符串内容，对字符串和字符串数组创建全文可以搜索的索引。

```
每个collection上一个全文索引，并且最多只有一个。text search和hints函数，如果查询包含$ text查询表达式，则不能使用hint。全文索引和排序，排序操作无法从文本索引获取排序顺序，即使是复合文本索引也是如此，即排序操作不能使用文本索引中的排序。复合索引可以包含文本索引键和升序降序索引键的组合，
```

hash索引，通配符索引，2dsphere索引等等

- 在A:{B,C}上建立索引，查询A:{B,C}和A:{C,B}都会使用索引么

由于mongodb索引使用B-树的原理，只会在A:{B,C}上使用索引。

- 聚合

todo

- sharding

sharding就是把数据水平切分到不同的物理节点上，利用sharding可以添加更多的及其来应对数据量的增加，以及读写操作的要求。

- 分片和复制是怎样工作的

每一个分片是一个分区数据的逻辑集合，分片可能是单一服务器也可以是集群。

- 如果块移动操作失败了，需要手动移除部分转移的文档么？

不需要，移动操作是一致和确定的，一次失败后悔不断重试，当完成的时候，数据只会出现在新的分片里。

- 数据什么时候回扩展到多个分片里

mongodb分片是基于区域的，当一个集合的所有对象被存放在一个块中，默认块的大小是64mb，当块超过了64mb，才有可能实施一个迁移。只有当存在不止一个块的时候，才会有多个分片获取数据的选项。

- 如果更新一个正在被迁移的块会发生什么

更新操作会立即发生在旧的块上，然后在所有权转移前复制到新的分片上。

- 如果一个分片查询很慢或者停止的时候，发起一个查询会怎样

如果停止了，除非设置了partial，否则会返回错误。如果很慢，会等待响应。

### 高可用

- master/primary

主从复制中的角色，Master是主节点，接收所有的写操作，并记录其操作日志中的数据集的所有更改，在集群中，主节点失效的时候，Secondary会成为master

- Slave/Secondary

复制主节点的oplog并将oplog记录的操作应用于其数据集，如果主节点宕机了，将从符合条件的从节点选举选出新的主节点。

- Arbiter

仲裁节点不维护数据集，仲裁节点的目的是通过响应其他副本节点的心跳和选举请求来维护副本集中的仲裁

- 复制集节点类型有哪些

优先级0型，隐藏型，延迟型，投票型

- 启动备份故障恢复要多久

从备份数据库声明主数据库宕机到选出一个备份数据库作为新的主数据库将花费10到30秒的时间，这个期间主数据库的操作将会失败，包括写入和强一致性读取操作。

- mongodb的数据同步形式

1，初始化同步，克隆除本地数据之外的所有数据库，mongod会扫描每个源数据库的每个集合，并将所有数据插入到这些集合的自己的副本中，初始同步会在每个集合复制文档的时候构建所有集合索引。

2，初始同步在数据复制期间提取新添加的oplog记录，确保目标成员在本地数据库中有足够的磁盘空间，以便在此数据复制阶段的持续时间内临时存储这些oplog记录。

3，将所有更改应用于数据集，使用来自源oplog来更新其数据集以反映副本集的当前状态，初始化同步完成之后，成员从startup2转换为secondary



- 标准复制集架构

三台服务器构成，包括三个数据节点，一主两从或者一个主一从一仲裁

- 节点类型

1，优先级0型节点

不可用成为主节点，也不能触发选举，将从节点配置为优先级为0防止它成为主节点，这在多数据中心部署中特别有用，在许多情况下，无需将备用节点设置为优先级0，但在某些场景下，可以通过这个设置让某些成员成为主节点。

2，隐藏型节点

隐藏型从节点是维护主数据集的副本，但对客户端应用程序来说不可见，隐藏型从节点适用于具有与副本集中其他成员不同的使用模式。

隐藏型从节点必须始终为优先级0型节点，所以不会成为主节点，但隐藏性节点可以参与投票。

隐藏型节点不会收到来自于应用程序的请求，我们可以从隐藏型从节点转用于报表节点或者备份节点。

3，延时型节点

是数据集的滚动备份或者运行快照，因为它们可以帮助从各种人为错误中恢复。延时型节点一定是隐藏型的和优先级0型的，不能成为主节点，也不能被客户端查询。

4，投票型节点/不可投票节点

复制集节点可以通过配置来决定该节点是否有投票权利，无表决权的节点必须优先级为0，虽然没有表决权，但是可以接受来自客户端的读取操作。

