## MongoDB 

### NOSQL

- 键值型

键值对，使用简单，过滤和多值更新不方便，代表有Redis。

- 列式存储

通常是来应对分布式存储海量数据，代表有HBase。

- 文档型

键值对存储累子，该类型的数据模型是版本化的文档，半结构化的文档以特定的格式存储，比如json，允许嵌套键值，文档型数据库比键值数据库的查询效率更高，代表有MongoDB。

- 图形型

使用灵活的图形模型，并且能够扩展到多个服务器上，代表有Neo4j。

### MongoDB的特点

- 基于文档式存储，支持bson格式。
- 全文索引，3.2版本之后支持文本全文索引。
- 高可用，支持多种集群模式，提供稳定服务。
- 数据分片存储，简单设置，自动完成分片存储。
- 高性能数据更新，3.0版本之后支持表级锁，部分数据结构支持无锁。
- 分布式查询，MapReduce原理，对请求拆分合并，支持复杂聚合运算。
- GridFS文件存储，支持大文件存储。
- 社区成熟，文档丰富。

### MongoDB组成

- mongos 

MongoDB前置机，用于命令分发，结果集合并。

- configserver

配置中心，所有元数据，分片信息，集群信息都保存在configserver中。

- mongod

存储实例，数据存储。

### MongoDB存储引擎及工作原理

2.6之前的版本是使用的MMAP1技术，数据库级别的锁，3.0之后的版本，缺省采用WiredTiger技术，实现了表级和行级的锁，行级别的锁，是将锁的颗粒度细分到具体的B+树上的对应节点，颗粒度比较细。

![avatar](C:\Users\31786\iCloudDrive\TechNote\Image\mongodb存储引擎工作原理.jpg)



过程如下：

1，客户端向mongos发送客户端请求。

2，从configserver获取查询语句对应的分片信息。

3，返回数据分片信息。

4，根据第三步的分片信息，将请求发送到对应的分片集群上。

5，将各个分片集群的结果进行合并并返回。

6，返回客户端请求。

### MongoDB分布式集群模型

- Master/Slaver

主从模型，适合简单小型应用，高可用要求较低。

主节点可以读写，而从节点只能读。如果主节点挂了，那么整个集群都挂了。

- ReplicaSet

复制模型，适应于中型应用，对可用性要求相对较高。

主节点可以读写，从节点只能读。主节点挂了，不会威胁到整个集群。

- sharding

分片模型，适用于高并发场景，对可用性要求比较高。

将一个数据集合，按照sharding key，依次存储在切片上，而切片上就是复制模型，切片之间相互独立。

比如一个表T = shard1 + shard2 + shard3，shard分片的各个节点上的数据其实是一样的，也就是复制模型，sharding key对应一个唯一索引，并不是指一个字段唯一性的索引。





### Redis和MongoDB的选择

- 协议上

MongoDB采用bson协议，redis采用类telnet协议。

- 性能

都依赖内存，MongoDB适用于TPS较高，Redis适用于TPS非常高。Redis优于MongoDB

- 可操作性

类似于关系型数据库，丰富的数据表达，MongoDB优于Redis

- 内存和存储

MongoDB适合大数据量存储，依赖于系统虚拟内存，采用镜像文件存储，内存占用率比较高，官方建议独立部署在64位系统，而Redis在2.0以后支持虚拟特性突破物理内存限制，并且可以设置时效性，这一点各有千秋，根据场景来选择。

- 可用性

MongoDB支持master/slave，ReplicaSet(内部采用paxos选举算法，自动故障检测)，autosharding机制，对客户端屏蔽故障转移和切片机制。redis依赖客户端实现分布式读写，主从复制的时候

，每次从节点重新连接主节点都要依赖整个快照，无增量复制，不支持auto sharding，需要依赖程序来实现一致性hash机制。MongoDB优于redis，单点问题上，MongoDB应用简单，相对用户透明，redis比较复杂，需要客户端主动解决，MongoDB一般使用复制模型和sharding相结合，复制模型侧重高可用，而sharding模型侧重性能和水平扩展。

- 可靠性

1.8之后，MongoDB采用了binlog支持持久化，redis依赖于快照进行持久化，AOF增强可靠性，但同时影响访问性能。

- 一致性

MongoDB不支持事务，靠客户端保证，redis支持事务，当比较脆，仅能保证事务的操作按顺序进行。这一点Redis优于MongoDB

- 数据分析

MongoDB内置数据分析功能，mapreduce。redis不支持，这一点MongoDB优于redis。

- 应用场景

MongoDB适用于海量数据访问效率，redis做缓存用比较好，不适合大数据量。



